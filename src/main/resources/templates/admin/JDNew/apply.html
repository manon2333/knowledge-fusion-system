<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>标注系统</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="stylesheet" href="/lib/layui/css/layui.css">
    <link rel="stylesheet" href="/style/admin_common.css">
    <script type="application/javascript" src="/js/jquery.min.js"></script>
    <script type="application/javascript" src="/js/jquery.cookie.js"></script>
    <script type="text/javascript" src="/lib/layui/layui.js"></script>
    <script type="application/javascript" src="/lib/echarts/echarts.min.js"></script>
    <script type="application/javascript" src="/js/g6.min.js"></script>
    <script type="text/javascript" src="/js/statistic.js"></script>
    <script type="text/javascript" src="/js/dataReport.js"></script>
    <style>
        .layui-nav{background:transparent; font-weight:400; padding:0; display: inline-block;}
        .layui-nav .layui-nav-item a{padding:0;}
        .layui-nav .layui-nav-more{display:none;}
        .layui-nav-bar{display:none;}
        .layui-nav .layui-nav-item{line-height:20px; vertical-align: baseline;}
        .layui-nav-child{top:22px; width: 90px; line-height: 26px; left:50%; margin-left: -45px;}
        .layui-nav-child dd{box-shadow:0 0 0 0 #FFF;}
        #open .layui-table tbody tr td dd a{margin:0; padding: 0; font-size:12px;}
        #open .layui-table tbody tr td dd a:hover{text-decoration:none;}
        #open .layui-table tbody tr td>a{display:inline-block;}
        #open .layui-table tbody tr td a{margin:0 8px;}
        .layui-nav .layui-nav-child dd.layui-this a, .layui-nav-child dd.layui-this{background:transparent;}
        .ctop{border:none;}
    </style>
</head>
<body class="openMenu">
<!-- 载入左侧菜单指向的jsp（或html等）页面内容 -->
<form class="layui-form iframe" action="javascript:;" id="search">

    <a href="javascript:history.back(-1)" class="layui-btn layui-border-black">返回</a>
<!--    <a href="javascript:;" class="layui-btn layui-border-black">消息</a>-->
    <div class="layui-inline inp_200">
        <label class="layui-form-label">标注人员</label>
        <div class="layui-input-inline" style="width: 200px;">
            <input type="text" name="dataSourceName" placeholder="请输入标注人员" autocomplete="off" class="layui-input keySc">
        </div>
    </div>
    <div class="layui-inline">
        <label class="layui-form-label">申请时间</label>
        <div class="layui-input-inline" style="width: 300px;">
            <input type="text" class="layui-input" id="test1" placeholder="请选择日期" autocomplete="off" lay-key="1" name="">
        </div>
    </div>
    <div class="layui-inline">
        <label class="layui-form-label">审核状态</label>
        <div class="layui-input-inline inp_150">
            <select name="czr" lay-filter="czr">
                <option value=""></option>
                <option value="李一">李一</option>
                <option value="李二">李二</option>
                <option value="111">111</option>
                <option value="222">222</option>
            </select>
        </div>
    </div>
    <div class="layui-inline">
        <label class="layui-form-label">审核人</label>
        <div class="layui-input-inline inp_150">
            <select name="czr" lay-filter="czr">
                <option value=""></option>
                <option value="李一">李一</option>
                <option value="李二">李二</option>
                <option value="111">111</option>
                <option value="222">222</option>
            </select>
        </div>
    </div>
</form>
<div class="" id="open">
    <form class="layui-form" action="javascript:;">
        <div class="ctop">
            <p class="c_fff fl">共<span class="totle"></span>记录，当前每页显示<span class="dq"></span>条</p>
            <button type="button" class="layui-btn layui-btn-normal plDel">批量删除</button>
            <button type="button" class="layui-btn layui-btn-normal plDel">批量通过</button>
            <button type="button" class="layui-btn layui-btn-normal plDel">批量不通过</button>
        </div>
        <!--    <div>每页显示 8 条 , 当前显示 1-8 条记录</div>-->
        <table class="layui-table">
            <colgroup>
                <col width="80">
                <col width="">
                <col width="150">
                <col width="100">
                <col width="100">
                <col width="200">
                <col width="100">
                <col width="280">
            </colgroup>
            <thead>
            <tr>
                <th><input type="checkbox" name="" lay-skin="primary" lay-filter="quanx"></th>
    <!--            <th>序号</th>-->
                <th>标注人员</th>
                <th>申请时间</th>
                <th>审核状态</th>
                <th>审核人</th>
                <th>审核时间</th>
                <th>新上传数据</th>
                <th>操作</th>
            </tr>
            </thead>
            <tbody class="ctList">
            <!--                <tr>-->
            <!--                  <td>1</td>-->
            <!--                  <td>海</td>-->
            <!--                  <td>结构化数据</td>-->
            <!--                  <td><span class="ok">已同步</span></td>-->
            <!--                  <td>60</td>-->
            <!--                  <td>2020-7-11 12:43:23</td>-->
            <!--                  <td>未删除</td>-->
            <!--                  <td>-->
            <!--                    <a href="javascript:;">开始同步</a>-->
            <!--                    <a href="javascript:;">暂停同步</a>-->
            <!--&lt;!&ndash;                    <a href="javascript:;">更多</a>&ndash;&gt;-->
            <!--                    <ul class="layui-nav">-->
            <!--                      <li class="layui-nav-item">-->
            <!--                          <a href="javascript:;">更多</a>-->
            <!--                          <dl class="layui-nav-child">-->
            <!--                              <dd><a href="javascript:;">手动同步</a></dd>-->
            <!--                              <dd><a href="./editSJY.html">编辑数据源</a></dd>-->
            <!--                              <dd><a href="javascript:;">删除数据源</a></dd>-->
            <!--                              <dd><a href="./sjyHtmlList.html">查看数据源</a></dd>-->
            <!--                          </dl>-->
            <!--                      </li>-->
            <!--                    </ul>-->
            <!--                  </td>-->
            <!--                </tr>-->
            <!--                <tr>-->
            <!--                    <td>2</td>-->
            <!--                    <td>海</td>-->
            <!--                    <td>结构化数据</td>-->
            <!--                    <td><span class="">未同步</span></td>-->
            <!--                    <td>60</td>-->
            <!--                    <td>2020-7-11 12:43:23</td>-->
            <!--                    <td>未删除</td>-->
            <!--                    <td>-->
            <!--                        <a href="javascript:;" class="disClick">开始同步</a>-->
            <!--                        <a href="javascript:;">暂停同步</a>-->
            <!--                        <ul class="layui-nav">-->
            <!--                            <li class="layui-nav-item">-->
            <!--                                <a href="javascript:;">更多</a>-->
            <!--                                <dl class="layui-nav-child">-->
            <!--                                    <dd><a href="javascript:;">手动同步</a></dd>-->
            <!--                                    <dd><a href="javascript:;">编辑数据源</a></dd>-->
            <!--                                    <dd><a href="javascript:;">删除数据源</a></dd>-->
            <!--                                    <dd><a href="javascript:;">查看数据源</a></dd>-->
            <!--                                </dl>-->
            <!--                            </li>-->
            <!--                        </ul>-->
            <!--                    </td>-->
            <!--                </tr>-->
            <!--                <tr>-->
            <!--                    <td>1</td>-->
            <!--                    <td>海</td>-->
            <!--                    <td>结构化数据</td>-->
            <!--                    <td><span class="no">同步失败</span></td>-->
            <!--                    <td>60</td>-->
            <!--                    <td>2020-7-11 12:43:23</td>-->
            <!--                    <td>未删除</td>-->
            <!--                    <td>-->
            <!--                        <a href="javascript:;">开始同步</a>-->
            <!--                        <a href="javascript:;">暂停同步</a>-->
            <!--                        <ul class="layui-nav">-->
            <!--                            <li class="layui-nav-item">-->
            <!--                                <a href="javascript:;">更多</a>-->
            <!--                                <dl class="layui-nav-child">-->
            <!--                                    <dd><a href="javascript:;">手动同步</a></dd>-->
            <!--                                    <dd><a href="javascript:;">编辑数据源</a></dd>-->
            <!--                                    <dd><a href="javascript:;">删除数据源</a></dd>-->
            <!--                                    <dd><a href="javascript:;">查看数据源</a></dd>-->
            <!--                                </dl>-->
            <!--                            </li>-->
            <!--                        </ul>-->
            <!--                    </td>-->
            <!--                </tr>-->
            </tbody>
        </table>
    </form>
    <div id="page1" style="text-align:center;"></div>
</div>
<script>
    var kVale = getUrlParam('kVale'); //搜索类型;
    var entType = ''; //搜索类型;
    var page = adminpages;
    var limit = 10;
    var password = 123;
    var files;
    var jkObj = {
        datasourcetype: '2', //数据源类型
        synchronizeState: '', //同步周期
        isdelete: '', //是否删除
        dataSourceName: '', //数据源名
        // pageNumber: '', //第几页
        // displayNumber: '' //展示页数
    }
    layui.use(['form','layer','laypage', 'upload', 'element', 'laydate'], function(){
        var form = layui.form;
        var layer = layui.layer;
        var element = layui.element;
        var laypage = layui.laypage;
        var upload = layui.upload;
        var laydate = layui.laydate;


        $('.keySc').val(kVale);

        //时间控件 - 申请时间
        laydate.render({
            elem: '#test1'
            ,type: 'datetime'
            ,range: '~' //或 range: '~' 来自定义分割字符
            ,done: function(value, date, endDate){
                var trr = value.split(' ~ ');
                // console.log(trr); //得到日期生成的值，如：2017-08-18
                // console.log(date); //得到日期时间对象：{year: 2017, month: 8, date: 18, hours: 0, minutes: 0, seconds: 0}
                // console.log(endDate); //得结束的日期时间对象，开启范围选择（range: true）才会返回。对象成员同上。
                // if(value != ''){
                //     jkObj.acquisitionTimeStart = trr[0];
                //     jkObj.acquisitionTimeEnd = trr[1];
                // }else{
                //     jkObj.acquisitionTimeStart = '';
                //     jkObj.acquisitionTimeEnd = '';
                // }
                // page = 1;
                // getList(jkObj,page,limit);
            }
        });

        //批量删除
        $('.plDel').on('click',function(){
            var arr = [];
            for(var i=0; i<$('.list_che').length; i++){
                if($('.list_che')[i].checked){
                    arr.push($('.list_che').eq(i).val());
                }
            }
            // console.log(arr);
            arr = arr.join(',')
            layer.confirm('确定删除么?', {icon: 3, title:'提示'}, function(index){
                delFn(jkObj.id,jkObj.datasourcetype,arr);
                layer.close(index);
            });
        });


        //单个数据源 - 手动同步
        $('.layui-table').on('click','.layui-nav-child .sdtb',function(){
            console.log($(this));
            var p = $(this).parents('dl');
            var ids = p.attr('daid');
            var type = p.attr('datype');
            console.log(ids,type);
            layer.confirm('确定开始手动同步么?', {icon: 3, title:'提示'}, function(index){
                $.ajax({
                    url:'/datasource/synchronizeField',
                    type:'post',
                    timeout : 1200000, //超时时间设置，单位毫秒
                    data:{id:ids},
                    success:function(msg){
                        console.log(msg);
                        return false;
                        if(msg.success) {
                            layer.msg(msg.msg,{
                                time: 1000 //2秒关闭（如果不配置，默认是3秒）
                            },function(){
                                // window.location.reload();
                                window.location.href = './sjyglList.html';
                            });
                        }else{
                            layer.msg(msg.msg);
                        }
                    },
                    error:function(err){
                        console.log(err);
                    }
                });
                layer.close(index);
            });
        });

        //删除单个数据源
        $('.layui-table').on('click','.layui-nav-child .del',function(){
            console.log($(this));
            var p = $(this).parents('dl');
            var ids = p.attr('daid');
            var type = p.attr('datype');
            console.log(ids,type);
            layer.confirm('确定删除么?', {icon: 3, title:'提示'}, function(index){
                delFn(ids,type);
                layer.close(index);
            });
        });

        // 开始同步  &&  暂停同步
        $('.ctList').on('click','.tbClick',function(){
            var trBox = $(this).parents('tr');
            var sId = trBox.attr('dataid');
            var pdz = $(this).text();
            var url = '';
            if(pdz == '开始同步'){
                url = '/datasource/startAutoSync';
            }else{
                url = '/datasource/stopAutoSync';
            }
            $.ajax({
                url:url,
                type:'post',
                data:{id:sId},
                success:function(msg){
                    console.log(msg);
                    // return false;
                    if(msg.success) {
                        layer.msg(msg.msg,{
                            time: 1000 //2秒关闭（如果不配置，默认是3秒）
                        },function(){
                            // window.location.reload();
                            window.location.href = './sjyglList.html';
                        });
                    }else{
                        layer.msg(msg.msg);
                    }
                },
                error:function(err){
                    console.log(err);
                }
            });

            console.log($(this));
        })

        //按钮 筛选项  数据类型/同步状态/是否删除
        $('.btnCont').on('click','.layui-btn',function(){

            if($(this).hasClass('cur')){
                $(this).removeClass('cur');
            }else{
                $(this).addClass('cur');
            }

            var p = $(this).parent('.btnCont');
            var dataType = p.attr('datatype');

            var z = '';
            p.find('.layui-btn').each(function(){
                if($(this).hasClass('cur')){
                    z += $(this).attr('dataid') + '|'
                }
            });
            z = z.substr(0,z.length-1)

            jkObj[dataType] = z;
            page = 1;
            getList(jkObj,page,limit);
        });

        form.render();

        /* 全选 */
        form.on('checkbox(quanx)', function(data){
            // console.log(data.elem); //得到checkbox原始DOM对象
            // console.log(data.elem.checked); //是否被选中，true或者false
            // console.log(data.value); //复选框value值，也可以通过data.elem.value得到
            // console.log(data.othis); //得到美化后的DOM对象
            var child = $('.list_che');
            console.log(child);
            child.each(function (index, item) {
                item.checked = data.elem.checked;
            });
            form.render('checkbox');
        });


        //单个删除
        $('.ctList').on('click','.delF',function(){
            console.log($(this));
            var ids = $(this).attr('data-id');
            layer.confirm('确定删除么?', {icon: 3, title:'提示'}, function(index){
                delFn(ids);
                layer.close(index);
            });
        });

        getList(jkObj,page,limit);

        $('.keySc').on('keyup',function (e) {
            var e = e || window.event;
            if(e.keyCode == 13){
                // window.location.href = '/admin/ctxj.html?kVale=' + $(this).val();

                jkObj.dataSourceName = $(this).val();
                page = 1;
                getList(jkObj,page,limit);
            }
        });

    });

    /**
     * 查询数据源(数据源列表页)
     * @param datasourcetype 数据源类型
     * @param synchronizeState 同步周期
     * @param isdelete 是否删除
     * @param dataSourceName 数据源名
     * @param pageNumber 第几页
     * @param displayNumber 展示页数
     * @return QueryResponse
     */

    function getList(obj,page,pageSize){

        $.ajax({
            url:'/datasource/alldatasource',
            type:'post',
            data:{dataSourceName:obj.dataSourceName,datasourcetype:obj.datasourcetype,synchronizeState:obj.synchronizeState,isdelete:obj.isdelete,pageNumber:page,displayNumber:pageSize},
            success:function(msg){
                $('.ctList').html('');
                var totals = 0;
                if(msg.success) {
                    var res = JSON.parse(msg.json);

                    console.log(res);
                    if(Math.ceil(res.total/pageSize) < page && Math.ceil(res.total/pageSize) != 0){
                        page = Math.ceil(res.total/pageSize) == 0 ? 1 : Math.ceil(res.total/pageSize);
                        getList(obj,page,limit);
                        return false;
                    }
                    var data = res.alldatalist;
                    var str = '';
                    for(var i=0; i<data.length; i++){

                        // str += '<tr>' +
                        //     '  <td><input class="list_che" type="checkbox" lay-skin="primary" value="' + data[i].relationId + '"></td>' +
                        //     '  <td>' + eval(i+1) + '</td>' +
                        //     '  <td>' + getTime(data[i].srcVersion) + '</td>' +
                        //     '  <td>' + data[i].endType + '</td>' +
                        //     '  <td>' + data[i].endName + '</td>' +
                        //     '  <td>' +
                        //     '' + data[i].relationId + '    <a href="../ctxjContent.html?id=&adminpages=">查看</a>' + page + '' +
                        //     '    <a href="javascript:;" class="delF" data-Id="' + data[i].relationId + '">删除</a>' +
                        //     '  </td>' +
                        //     '</tr>';

                        var isdelete = '';
                        var datatype = '';
                        var synchronizeState = '';

                        if(data[i].isdelete == 0){
                            isdelete = '未删除';
                        }else{
                            isdelete = '已删除';
                        }
                        var editUrl = '';

                        if(data[i].datatype == 0){
                            datatype = '结构化';
                            editUrl = './editSJY1.html';
                        }else{
                            datatype = '非结构化';
                            editUrl = './editSJY2.html';
                        }

                        var state1 = '<a href="javascript:;" class="tbClick">开始同步</a><a href="javascript:;" class="disClick">暂停同步</a>'
                        var state2 = '<a href="javascript:;" class="disClick">开始同步</a><a href="javascript:;" class="tbClick">暂停同步</a>'
                        var state = '';
                        if(data[i].synchronizeState == 0){
                            synchronizeState = '<span>未同步</span>';
                            state = state1;
                        }else if(data[i].synchronizeState == 1){
                            synchronizeState = '<span class="ok">已同步</span>';
                            state = state2;
                        }else if(data[i].synchronizeState == 2){
                            synchronizeState = '<span class="ok">已同步</span>';
                            state = state1;
                        }else if(data[i].synchronizeState == 3){
                            synchronizeState = '<span class="no">同步失败</span>';
                            state = state1;
                        }else if(data[i].synchronizeState == 4){
                            synchronizeState = '<span class="no">同步失败</span>';
                            state = state2;
                        }else if(data[i].synchronizeState == 5){
                            synchronizeState = '<span class="ok">已同步</span>';
                            state = state1;
                        }

                        var synchronizePosition = getTime(data[i].synchronizePosition);

                        str += '<tr dataid="' + data[i].id + '">' +
                            '  <td><input class="list_che" type="checkbox" lay-skin="primary" value="' + data[i].id + '"></td>' +
                            // '  <td>' + eval(i+1) + '</td>' +
                            '  <td><a href="./applyInfo.html?types=' + data[i].id + '_' + data[i].datatype + '&sourceName=' + data[i].dataSourceName + '">' + data[i].dataSourceName + '</a></td>' +
                            '  <td>' + datatype + '</td>' +
                            '  <td>' + synchronizeState + '</td>' +
                            '  <td>' + data[i].synchronizeCycle + '</td>' +
                            '  <td>' + synchronizePosition + '</td>' +
                            '  <td>' + isdelete + '</td>' +
                            '  <td><a href="./applyInfo.html?id=' + data[i].id + '" class="tbClick">查看</a>' + state +
                            '    <ul class="layui-nav">' +
                            '      <li class="layui-nav-item">' +
                            '          <a href="javascript:;">更多</a>' +
                            '          <dl class="layui-nav-child" daid="' + data[i].id + '" datype="' + data[i].datatype + '">' +
                            '              <dd><a href="javascript:;" class="sdtb">手动同步</a></dd>' +
                            '              <dd><a href="' + editUrl + '?types=' + data[i].id + '_' + data[i].datatype + '">编辑数据源</a></dd>' +
                            '              <dd><a href="javascript:;" class="del">删除数据源</a></dd>' +
                            '              <dd><a href="./sjyHtmlList.html?types=' + data[i].id + '_' + data[i].datatype + '&sourceName=' + data[i].dataSourceName + '">查看数据源</a></dd>' +
                            '          </dl>' +
                            '      </li>' +
                            '    </ul>' +
                            '  </td>' +
                            '</tr>';

                    }
                    totals = res.total;
                    $('.totle').text(totals);
                    $('.dq').text(limit);
                    $('.ctList').html(str);
                    layui.use(['element'], function(){

                        var element = layui.element;
                        element.render();
                    })

                    // console.log(page);

                }else{
                    layer.msg(msg.msg);
                }

                pageFn(totals)
            },
            error:function(err){
                console.log(err);
            }
        });
    }

    function pageFn(total){
        layui.use(['form','laypage'], function() {
            var form = layui.form;
            var laypage = layui.laypage;

            laypage.render({
                elem: 'page1'
                ,count: total
                ,curr:page
                ,limit:limit
                // ,layout: ['count', 'prev', 'page', 'next', 'limit', 'refresh', 'skip']
                ,layout: ['prev', 'page', 'next', 'limit', 'skip']
                ,jump: function(obj,first){
                    // console.log(obj);
                    if(!first){
                        //do something
                        page = obj.curr;
                        limit = obj.limit;
                        // getList(kVale,page,limit);
                        getList(jkObj,page,limit);
                    }

                }
            });

            form.render('checkbox');

        });
    }
    function delFn(id,type){
        $.ajax({
            url:'/datasource/deleteDatasourceById',
            type:'post',
            data:{id:id,datasourcetype:type},
            success:function(msg){
                console.log(msg);
                // return false;
                if(msg.success) {
                    layer.msg(msg.msg,{
                        time: 1000 //2秒关闭（如果不配置，默认是3秒）
                    },function(){
                        // window.location.reload();
                        window.location.href = './sjyglList.html';
                    });
                }else{
                    layer.msg(msg.msg);
                }
            },
            error:function(err){
                console.log(err);
            }
        });
    }
</script>
</body>
</html>